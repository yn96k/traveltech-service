<table>
  <thead>
    <tr>
      <th>UC-01</th>
      <th>Синхронизация данных после оффлайна и обнаружение конфликтов</th>
    </tr>
  </thead> 
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>Пользователь, Сервис синхронизации</td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td> 
      <td>
        1. Пользователь авторизован. <br>
        2. Наличие локальных событий в оффлайн-буфере клиента. <br>
        3. Восстановление сетевого соединения. 
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Основной поток</strong>
      </td> 
      <td>
          1. Пользователь передает пакет изменений вместе с историей версий в сервис синхронизации. <br>
          2. Сервис сопоставляет историю правок пользователя с текущим состоянием данных на сервере. <br>
          3. Сервис выявляет несовместимые правки (например, редактирование одного и того же рейса разными значениями). <br>
          4. Сервис проверяет, является ли локальная версия слишком устаревшей (например объект изменения удален или уже забронирован) 
          5. Сервис сохраняет входящие правки в защищенный лог без изменения основного плана. <br>
          6. Регистрация записи в таблице конфликтов.
          7. Сервис отправляет уведомление всем участникам группы о необходимости ручного вмешательства.
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Постусловия</strong>
      </td>
      <td> 
        1. Создана запись об инциденте конфликта.<br>
        2. Основная ветка плана осталась без изменений. <br>
        3. Участники группы уведомлены о наличии конфликта в планах поездки. <br>
        4. Локальные изменения пользователя не пропали, а ожидают ручного слияния.
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Исключения</strong>
      </td> 
      <td> 
        1. Сервер временно не может обработать пакет. (шаг 1) <br>
        1.1. Запрос ставится в очередь на повторы на стороне клиента с увеличивающейся задержкой. <br>
        2. Данные клиента базируются на слишком старой версии, которая уже была глубоко изменена. (шаг 4) <br>
        2.1. Система отклоняет локальный пакет событий и загружает пользователю актуальную версию.
        2.2. Пользователь информируется о том, что его локальные изменения отклонены и по каким причинам.
      </td> 
    </tr> 
  </tbody> 
</table>

<br>

<table>
  <thead>
    <tr>
      <th>UC-02</th>
      <th>Ручное разрешение конфликта версий</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>Организатор поездки / Участник с правами редактора, Сервис синхронизации</td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td>
      <td>
        1. Наличие записи со статусом конфликта в планах поездки. <br>
        2. Пользователь обладает правами записи в текущей поездке. 
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Основной поток</strong>
      </td>
      <td>1. Запрос деталей конфликта через GET /v1/conflicts/{id}.
          <br>2. Визуализация конфликтующих версий пользователю.
          <br>3. Отправка выбранной версии через POST /v1/conflicts/{id}/resolve.
          <br>4. Создание MERGE_EVENT в событийном логе.
          <br>5. Пересчет и обновление проекции (Read Model). </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Постусловия</strong>
      </td>
      <td>Запись конфликта переведена в состояние RESOLVED; проекция плана обновлена.</td> 
    </tr> 
    <tr> 
      <td>
        <strong>Исключения</strong>
      </td> 
      <td>E1: Конфликт уже разрешен другим участником (409 Conflict).
          <br>E2: Объект был удален из маршрута (404 Not Found). </td> 
    </tr> 
  </tbody> 
</table>

<br>

<table> 
  <thead> 
    <tr> 
      <th>UC-03</th> 
      <th>Надежное бронирование через внешние API (Saga)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>Пользователь, Booking Engine, PII Vault, Внешний адаптер (GDS)</td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td>
      <td>1. Объект маршрута находится в статусе CONFIRMED.
          <br>2. В хранилище PII Vault присутствуют необходимые персональные данные.</td>
    </tr>
    <tr>
      <td>
        <strong>Основной поток</strong>
      </td>
      <td>1. Инициация бронирования через POST /v1/bookings/execute.
          <br>2. Запрос защищенных данных в PII Vault по TokenID.
          <br>3. Вызов внешнего адаптера с маскированием данных.
          <br>4. Получение подтверждения (PNR) от поставщика.
          <br>5. Обновление статуса в Read Model на BOOKED.</td>
    </tr>
    <tr>
      <td>
        <strong>Постусловия</strong>
      </td>
      <td>Услуга забронирована у внешнего поставщика; данные в плане синхронизированы.</td>
    </tr>
    <tr>
      <td>
        <strong>Исключения</strong>
      </td>
      <td>E1: Срабатывание Circuit Breaker внешнего API (Прерывание транзакции).
          <br>E2: Несоответствие данных в Vault требованиям перевозчика (Отказ). 
      </td> 
    </tr>
  </tbody>
</table>
