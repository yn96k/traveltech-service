<table>
  <thead>
    <tr>
      <th>UC-01</th>
      <th>Синхронизация данных после оффлайна и обнаружение конфликтов</th>
    </tr>
  </thead> 
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>Пользователь, Сервис синхронизации</td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td> 
      <td>
        1. Пользователь авторизован. <br>
        2. Наличие локальных событий в оффлайн-буфере клиента. <br>
        3. Восстановление сетевого соединения. 
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Основной поток</strong>
      </td> 
      <td>
          1. Пользователь передает пакет изменений вместе с историей версий в сервис синхронизации. <br>
          2. Сервис сопоставляет историю правок пользователя с текущим состоянием данных на сервере. <br>
          3. Сервис выявляет несовместимые правки (например, редактирование одного и того же рейса разными значениями). <br>
          4. Сервис проверяет, является ли локальная версия слишком устаревшей (например объект изменения удален или уже забронирован) 
          5. Сервис сохраняет входящие правки в защищенный лог без изменения основного плана. <br>
          6. Регистрация записи в таблице конфликтов.
          7. Сервис отправляет уведомление всем участникам группы о необходимости ручного вмешательства.
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Постусловия</strong>
      </td>
      <td> 
        1. Создана запись об инциденте конфликта.<br>
        2. Основная ветка плана осталась без изменений. <br>
        3. Участники группы уведомлены о наличии конфликта в планах поездки. <br>
        4. Локальные изменения пользователя не пропали, а ожидают ручного слияния.
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Исключения</strong>
      </td> 
      <td> 
        1. Сервер временно не может обработать пакет. (шаг 1) <br>
        1.1. Запрос ставится в очередь на повторы на стороне клиента с увеличивающейся задержкой. <br><br>
        2. Данные клиента базируются на слишком старой версии, которая уже была глубоко изменена. (шаг 4) <br>
        2.1. Система отклоняет локальный пакет событий и загружает пользователю актуальную версию.
        2.2. Пользователь информируется о том, что его локальные изменения отклонены и по каким причинам.
      </td> 
    </tr> 
  </tbody> 
</table>

<br>

<table>
  <thead>
    <tr>
      <th>UC-02</th>
      <th>Ручное разрешение конфликта версий</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>Организатор поездки / Участник с правами редактора, Сервис синхронизации</td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td>
      <td>
        1. Наличие записи со статусом конфликта в планах поездки. <br>
        2. Пользователь обладает правами записи в текущей поездке. 
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Основной поток</strong>
      </td>
      <td>
          1. Пользователь открывает список активных противоречий в поездке. <br>
          2. Система отображает сравнительный вид: текущая версия плана против предложенных изменений. <br>
          3. Пользователь выбирает одну из версий как приоритетную. <br>
          4. Система создает запись о слиянии, которая объединяет разрозненные ветки истории. <br>
          5. Система закрывает инцидент противоречия. <br>
          6. Система обновляет основной план для всех участников группы. <br>
          7. Система рассылает обновленное состояние всем активным пользователям.
      </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Постусловия</strong>
      </td>
      <td>
        1. Противоречие устранено у всех участников группы способом, который выбрал пользователь. <br>
        2. Основная ветка плана обновлена. </td> 
    </tr> 
    <tr> 
      <td>
        <strong>Исключения</strong>
      </td> 
      <td>
        1. Потеря связи в момент выбора. (шаг 3) <br>
        1.1. Запрос ставится в очередь на повторы на стороне клиента с увеличивающейся задержкой. <br><br>
        2. Конфликт уже разрешен другим участником. (шаг 4)<br>
        2.1. Система блокирует попытку повторного слияния. <br>
        2.2. Система уведомляет пользователя о том, что слияние уже выполнено другим пользователем. <br>
      </td> 
    </tr> 
  </tbody> 
</table>

<br>

<table> 
  <thead> 
    <tr> 
      <th>UC-03</th> 
      <th>Надежное бронирование через внешние API</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <strong>Акторы</strong>
      </td>
      <td>
        1. Пользователь с правами бронирования.<br> 
        2. Сервис бронирования.<br> 
        3. Защищенное хранилище личных данных.<br>
        4. Внешний сервис услуг (билеты, отели и т.д.).<br> 
      </td>
    </tr>
    <tr>
      <td>
        <strong>Предусловия</strong>
      </td>
      <td>
        1. Элемент маршрута утвержден. <br>
        2. В защищенном хранилище имеются актуальные паспортные данные пользователя.
      </td>
    </tr>
    <tr>
      <td>
        <strong>Основной поток</strong>
      </td>
      <td>
        1. Пользователь инициирует процесс бронирования конкретной позиции. <br>
        2. Система блокирует возможность редактирования этой позиции другими участниками группы. <br>
        3. Система запрашивает у защищенного хранилища временный доступ к зашифрованным данным пользователя. <br>
        4. Система передает паспортные данные и параметры бронирования внешнему сервису через защищенный канал и ожидает подтверждения. <br>
        5. Система сохраняет номер бронирования и электронные билеты в плане. <br>
        5. Система снимает блокировку и меняет статус позиции на подтвержденный для всей группы.
      </td>
    </tr>
    <tr>
      <td>
        <strong>Постусловия</strong>
      </td>
      <td>
        1. Подтверждение брони получено. <br>
        2. Данные в плане зафиксированы и защищены от правок. <br>
      </td>
    </tr>
    <tr>
      <td>
        <strong>Исключения</strong>
      </td>
      <td>
        1. Внешнее API не отвечает или вернуло ошибку. (шаг 4) <br>
        1.1. Сессия бронирования сбрасывается, защищенный канал для передачи личных данных блокируется. <br>
        1.2. Блокировка с позиции в плане снимается, статус откатывается к состоянию «Доступно для бронирования». <br>
        1.3. Пользователь получает уведомление о том, что бронирование не удалось так как внешний сервис временно недоступен, средства не списаны. <br><br>
        2. Ошибка валидации паспортных данных у внешнего сервиса. (шаг 4)<br>
        2.1. Сессия бронирования сбрасывается, защищенный канал для передачи личных данных блокируется. <br>
        2.2. Блокировка с позиции в плане снимается, статус откатывается к состоянию «Доступно для бронирования». <br>
        2.3. Пользователь получает уведомление о том, что бронирование не удалось так как в паспортных данных есть ошибка, средства не списаны. <br><br>
        3. Цена услуги у внешнего сервиса изменилась в процессе бронирования. (шаг 4)<br>
        3.1. Сессия бронирования сбрасывается, защищенный канал для передачи личных данных блокируется. <br>
        3.2. Блокировка с позиции в плане снимается, статус откатывается к состоянию «Доступно для бронирования». <br>
        3.3. Пользователь получает уведомление о том, что бронирование не удалось так как стоимость услуги изменилась, средства не списаны. <br>
      </td> 
    </tr>
  </tbody>
</table>
